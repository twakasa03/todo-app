<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* ベースカラー、スペーシング、フォント設定 */
        :root {
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --font-family: 'Noto Sans JP', sans-serif;
            --transition-speed: 0.3s;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
        }

        :root[data-theme="light"] {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #e9ecef;
            --hover-color: #f1f3f5;
            --card-bg: #ffffff;
            --primary-color: #228be6;
            --secondary-color: #868e96;
            --priority-high-bg: #fff5f5;
            --priority-medium-bg: #fff9db;
            --priority-low-bg: #ebfbee;
            --priority-high-color: #fa5252;
            --priority-medium-color: #fab005;
            --priority-low-color: #40c057;
        }

        :root[data-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --border-color: #343a40;
            --hover-color: #2a2d31;
            --card-bg: #343a40;
            --primary-color: #74c0fc;
            --secondary-color: #adb5bd;
            --priority-high-bg: #4a1f1f;
            --priority-medium-bg: #4a3b1f;
            --priority-low-bg: #1f4a20;
            --priority-high-color: #ff8787;
            --priority-medium-color: #ffd43b;
            --priority-low-color: #69db7c;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header h1 .material-icons {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .theme-toggle .material-icons {
            font-size: 1.2rem;
        }

        .task-form {
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .button-primary {
            background: var(--primary-color);
            color: white;
        }

        .button-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .task-form .form-row {
                flex-direction: column;
            }
            .task-controls {
                flex-direction: column;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 3px;
            color: var(--text-color);
            cursor: pointer;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .task-form {
            margin-bottom: 20px;
            display: grid;
            gap: 10px;
        }

        .task-form .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .task-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-item.priority-high {
            background-color: var(--priority-high-bg);
            border-left: 4px solid var(--priority-high-color);
        }

        .task-item.priority-medium {
            background-color: var(--priority-medium-bg);
            border-left: 4px solid var(--priority-medium-color);
        }

        .task-item.priority-low {
            background-color: var(--priority-low-bg);
            border-left: 4px solid var(--priority-low-color);
        }

        .task-item.completed {
            opacity: 0.7;
            background-color: var(--hover-color);
        }

        .task-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-title {
            font-weight: bold;
            cursor: pointer;
        }

        .task-meta {
            font-size: 0.8em;
            color: #666;
        }

        .task-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .subtasks {
            margin-left: 20px;
            margin-top: 5px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 0;
        }

        .priority-high { color: #ff4444; }
        .priority-medium { color: #ffaa00; }
        .priority-low { color: #44aa44; }

        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #4444ff;
            color: white;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .delete-btn {
            background: #ff4444;
        }

        .add-subtask-btn {
            background: #44aa44;
            margin-top: 5px;
        }

        input[type="text"],
        input[type="date"],
        select,
        .tag-input {
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .category-badge {
            background: #4444ff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .due-date {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .due-date.urgent {
            background-color: var(--priority-high-color);
            color: white;
        }

        .due-date.warning {
            background-color: var(--priority-medium-color);
            color: white;
        }

        .due-date.normal {
            background-color: var(--priority-low-color);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--priority-high-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: #4444ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(68,68,255,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #4444ff;
            transition: width 0.3s ease;
        }

        .task-group {
            border-left: 4px solid #4444ff;
            margin-left: 20px;
            padding-left: 10px;
        }

        .recurrence-badge {
            background-color: #9c27b0;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .group-toggle {
            cursor: pointer;
            user-select: none;
            margin-right: 8px;
        }

        .group-toggle::before {
            content: '▼';
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .group-toggle.collapsed::before {
            transform: rotate(-90deg);
        }

        .task-group-container {
            transition: height 0.3s ease;
            overflow: hidden;
        }

        .progress-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .progress-buttons {
            display: flex;
            gap: 5px;
        }

        .progress-btn {
            padding: 2px 8px;
            font-size: 1.2em;
            min-width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sort-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        #sortDirection {
            padding: 5px 10px;
            font-size: 1.2em;
            min-width: 40px;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
        }
        .sortable-chosen {
            background-color: #e8e8e8;
        }
        .sortable-drag {
            opacity: 0.8;
        }
        .task-header {
            cursor: move;
        }

        /* 検索ボックスとコントロールスタイル */
        .search-and-controls {
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-box .material-icons {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .task-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .sort-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sort-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .button-icon {
            padding: 8px;
            min-width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
        }

        .button-icon:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .button-icon .material-icons {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        /* タスクリストのスタイル改善 */
        .task-list {
            display: grid;
            gap: 1rem;
            padding: 0;
        }

        .task-item {
            background: var(--bg-color);
            border: none;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 0;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .task-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .task-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .task-checkbox:checked {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .task-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 16px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .task-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
            color: var(--text-color);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .meta-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.9rem;
            background: var(--hover-color);
            color: var(--text-color);
        }

        .meta-item .material-icons {
            font-size: 1rem;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .priority-high {
            background: var(--priority-high-bg);
            color: var(--priority-high-color);
        }

        .priority-medium {
            background: var(--priority-medium-bg);
            color: var(--priority-medium-color);
        }

        .priority-low {
            background: var(--priority-low-bg);
            color: var(--priority-low-color);
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
        }

        .task-actions .button {
            padding: 6px;
            min-width: 32px;
            height: 32px;
        }

        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .progress-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .progress-buttons .button {
            padding: 4px;
            min-width: 28px;
            height: 28px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .task-controls {
                grid-template-columns: 1fr;
            }

            .task-header {
                grid-template-columns: auto 1fr;
            }

            .task-actions {
                grid-column: 1 / -1;
                justify-content: flex-end;
                margin-top: 1rem;
            }
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            height: fit-content;
        }

        .search-box {
            position: relative;
            margin-bottom: var(--spacing-md);
        }

        .search-box .material-icons {
            position: absolute;
            left: var(--spacing-sm);
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) calc(var(--spacing-lg) + var(--spacing-xs));
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 0.95rem;
            transition: all var(--transition-speed);
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.1);
        }

        .filter-group, .sort-group {
            background: var(--bg-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .filter-group label, .sort-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            color: var(--secondary-color);
            font-size: 0.9rem;
            font-weight: 500;
        }

        select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.1);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-md);
        }

        .task-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .task-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-speed);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            opacity: 0.5;
        }

        .task-item.priority-high::before {
            background: var(--priority-high-color);
        }

        .task-item.priority-medium::before {
            background: var(--priority-medium-color);
        }

        .task-item.priority-low::before {
            background: var(--priority-low-color);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .task-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            padding-right: var(--spacing-md);
        }

        .button-container {
            display: flex;
            gap: var(--spacing-xs);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .button.delete-btn {
            background: var(--priority-high-color);
        }

        .button.add-subtask-btn {
            background: var(--priority-low-color);
            width: 100%;
            margin-top: var(--spacing-sm);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin: var(--spacing-sm) 0;
        }

        .meta-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.85rem;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .meta-item .material-icons {
            font-size: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width var(--transition-speed);
        }

        .progress-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-xs);
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .progress-buttons {
            display: flex;
            gap: var(--spacing-xs);
        }

        .progress-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 4px;
            background: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .progress-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .subtasks {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-color);
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) 0;
        }

        .subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        .subtask-item span {
            flex: 1;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: var(--spacing-sm);
            }

            .sidebar {
                width: 100%;
                margin-bottom: var(--spacing-md);
            }

            .task-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span class="material-icons">task_alt</span>
            TODOアプリ
        </h1>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span class="material-icons">dark_mode</span>
            テーマ切替
        </button>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="search-box">
                <span class="material-icons">search</span>
                <input type="text" id="searchInput" placeholder="タスクを検索..." onkeyup="debounce(loadTasks, 300)()">
            </div>

            <div class="filter-group">
                <label for="statusFilter">
                    <span class="material-icons">filter_list</span>
                    ステータス
                </label>
                <select id="statusFilter" onchange="loadTasks()">
                    <option value="all">すべて</option>
                    <option value="active">未完了</option>
                    <option value="completed">完了</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="categoryFilter">
                    <span class="material-icons">folder</span>
                    カテゴリー
                </label>
                <select id="categoryFilter" onchange="loadTasks()">
                    <option value="">すべて</option>
                </select>
            </div>

            <div class="sort-group">
                <label for="sortField">
                    <span class="material-icons">sort</span>
                    並び替え
                </label>
                <div class="sort-controls">
                    <select id="sortField" onchange="updateSortOrder()">
                        <option value="position">カスタム順</option>
                        <option value="due_date">期限日</option>
                        <option value="priority">優先度</option>
                        <option value="created_at">作成日時</option>
                    </select>
                    <button id="sortDirection" class="button" onclick="toggleSortDirection()">
                        <span class="material-icons">arrow_upward</span>
                    </button>
                </div>
            </div>

            <form id="taskForm" class="task-form">
                <div class="form-group">
                    <label for="taskInput">
                        <span class="material-icons">add_task</span>
                        新しいタスク
                    </label>
                    <input type="text" id="taskInput" placeholder="タスク名を入力" required>
                </div>

                <div class="form-group">
                    <label for="dueDateInput">
                        <span class="material-icons">event</span>
                        期限日
                    </label>
                    <input type="date" id="dueDateInput">
                </div>

                <div class="form-group">
                    <label for="priorityInput">
                        <span class="material-icons">priority_high</span>
                        優先度
                    </label>
                    <select id="priorityInput">
                        <option value="high">高</option>
                        <option value="medium" selected>中</option>
                        <option value="low">低</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="categoryInput">
                        <span class="material-icons">folder</span>
                        カテゴリー
                    </label>
                    <input type="text" id="categoryInput" placeholder="カテゴリーを入力">
                </div>

                <div class="form-group">
                    <label for="tagsInput">
                        <span class="material-icons">label</span>
                        タグ
                    </label>
                    <input type="text" id="tagsInput" placeholder="タグをカンマ区切りで入力">
                </div>

                <div class="form-group">
                    <label for="totalSteps">
                        <span class="material-icons">checklist</span>
                        総ステップ数
                    </label>
                    <input type="number" id="totalSteps" placeholder="0" min="0">
                </div>

                <div class="form-group">
                    <label for="recurrenceType">
                        <span class="material-icons">repeat</span>
                        繰り返し
                    </label>
                    <select id="recurrenceType">
                        <option value="">繰り返しなし</option>
                        <option value="daily">毎日</option>
                        <option value="weekly">毎週</option>
                        <option value="monthly">毎月</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="recurrenceInterval">
                        <span class="material-icons">update</span>
                        繰り返し間隔
                    </label>
                    <input type="number" id="recurrenceInterval" placeholder="1" min="1" value="1">
                </div>

                <div class="form-group">
                    <label for="groupSelect">
                        <span class="material-icons">folder_special</span>
                        グループ
                    </label>
                    <select id="groupSelect">
                        <option value="">グループなし</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="button" onclick="createGroup()">
                        <span class="material-icons">create_new_folder</span>
                        新規グループ
                    </button>
                    <button type="submit" class="button">
                        <span class="material-icons">add_task</span>
                        タスクを追加
                    </button>
                </div>
            </form>
        </div>

        <div class="content-area">
            <ul id="taskList" class="task-list"></ul>
        </div>
    </div>

    <script>
        const API_URL = 'https://todo-app-production-dfbf.up.railway.app';
        let currentEditingId = null;
        let debounceTimer;

        // デージ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            updateGroupSelect();
            setupEventListeners();
        });

        // イベントリスナーの設定
        function setupEventListeners() {
            document.getElementById('taskForm').addEventListener('submit', handleSubmit);
            document.getElementById('searchInput').addEventListener('input', debounce(loadTasks, 300));
            document.getElementById('statusFilter').addEventListener('change', loadTasks);
            document.getElementById('categoryFilter').addEventListener('change', loadTasks);
            document.getElementById('sortField').addEventListener('change', updateSortOrder);
        }

        // フォームの送信処理
        async function handleSubmit(e) {
            e.preventDefault();
            const formData = {
                title: document.getElementById('taskInput').value.trim(),
                due_date: document.getElementById('dueDateInput').value || null,
                priority: document.getElementById('priorityInput').value,
                category: document.getElementById('categoryInput').value.trim() || null,
                tags: document.getElementById('tagsInput').value.trim() ? 
                      document.getElementById('tagsInput').value.split(',').map(tag => tag.trim()) : null,
                total_steps: document.getElementById('totalSteps').value ? 
                            parseInt(document.getElementById('totalSteps').value) : null,
                group_id: document.getElementById('groupSelect').value || null
            };

            try {
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                if (response.ok) {
                    document.getElementById('taskForm').reset();
                    loadTasks();
                }
            } catch (error) {
                console.error('タスクの作成に失敗しました:', error);
            }
        }

        // デバウンス関数
        function debounce(func, wait) {
            return function executedFunction() {
                const later = () => {
                    clearTimeout(debounceTimer);
                    func();
                };
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(later, wait);
            };
        }

        // テーマ切り替え
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // 保存されたテーマを適用
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // グループを作成
        async function createGroup() {
            const title = prompt('グループ名を入力してください:');
            if (title) {
                try {
                    const response = await fetch(`${API_URL}/tasks/groups`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ title }),
                    });
                    if (response.ok) {
                        loadTasks();
                        updateGroupSelect();
                    }
                } catch (error) {
                    console.error('グループの作成に失敗しました:', error);
                }
            }
        }

        // グループ選択肢を更新
        async function updateGroupSelect() {
            try {
                const response = await fetch(`${API_URL}/tasks?status=all`);
                const tasks = await response.json();
                const groupSelect = document.getElementById('groupSelect');
                groupSelect.innerHTML = '<option value="">グループなし</option>';
                
                tasks.filter(task => task.is_group).forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.title;
                    groupSelect.appendChild(option);
                });
            } catch (error) {
                console.error('グループ一覧の取得に失敗しました:', error);
            }
        }

        // タスクの進捗を更新
        async function updateProgress(taskId, progress) {
            try {
                const response = await fetch(`${API_URL}/tasks/${taskId}/progress`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ progress }),
                });
                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('進捗の更新に失敗しました:', error);
            }
        }

        // グループの表示/非表示を切り替え
        function toggleGroup(groupId) {
            const container = document.querySelector(`.task-group-container[data-group="${groupId}"]`);
            const toggle = document.querySelector(`.group-toggle[data-group="${groupId}"]`);
            
            if (container.style.height === '0px') {
                container.style.height = container.scrollHeight + 'px';
                toggle.classList.remove('collapsed');
            } else {
                container.style.height = '0px';
                toggle.classList.add('collapsed');
            }
        }

        // タスク一覧を表示（更新版）
        async function loadTasks() {
            try {
                const status = document.getElementById('statusFilter').value;
                const category = document.getElementById('categoryFilter').value;
                const sortField = document.getElementById('sortField').value;
                const sortDirection = document.getElementById('sortDirection').textContent.trim() === '↑' ? 'asc' : 'desc';
                const search = document.getElementById('searchInput').value;

                const sort = sortField === 'position' ? 'position' : `${sortField}:${sortDirection}`;
                
                const queryParams = new URLSearchParams({
                    status,
                    sort,
                    search: search || ''
                });
                
                if (category) {
                    queryParams.append('category', category);
                }

                const response = await fetch(`${API_URL}/tasks?${queryParams}`);
                const tasks = await response.json();
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '';
                
                // グループごとにタスクを理
                const groupedTasks = {};
                tasks.forEach(task => {
                    if (task.is_group) {
                        groupedTasks[task.id] = {
                            group: task,
                            tasks: []
                        };
                    }
                });
                
                tasks.forEach(task => {
                    if (!task.is_group && task.group_id) {
                        if (groupedTasks[task.group_id]) {
                            groupedTasks[task.group_id].tasks.push(task);
                        }
                    }
                });
                
                // タスクを表示
                tasks.forEach(task => {
                    if (!task.group_id) {
                        const li = createTaskElement(task);
                        
                        if (task.is_group && groupedTasks[task.id]) {
                            const groupContainer = document.createElement('div');
                            groupContainer.className = 'task-group-container';
                            groupContainer.dataset.group = task.id;
                            
                            groupedTasks[task.id].tasks.forEach(groupTask => {
                                groupContainer.appendChild(createTaskElement(groupTask));
                            });
                            
                            li.appendChild(groupContainer);
                        }
                        
                        taskList.appendChild(li);
                    }
                });

                // ドラッグ&ドロップを設定（position選択時のみ）
                if (sortField === 'position') {
                    setupDragAndDrop();
                }
            } catch (error) {
                console.error('タスクの取得に失敗しました:', error);
            }
        }

        // タスク要素を作成（更新版）
        function createTaskElement(task) {
            const li = document.createElement('li');
            li.className = `task-item priority-${task.priority} ${task.completed ? 'completed' : ''}`;
            li.dataset.id = task.id;
            
            const content = document.createElement('div');
            content.className = 'task-content';
            
            // ヘッダー部分
            const header = document.createElement('div');
            header.className = 'task-header';
            
            // チェックボックス
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = task.completed;
            checkbox.onclick = () => toggleTask(task.id);
            header.appendChild(checkbox);
            
            // タイトル
            const titleContainer = document.createElement('div');
            titleContainer.className = 'task-title-container';
            
            if (task.is_group) {
                const groupToggle = document.createElement('span');
                groupToggle.className = 'material-icons group-toggle';
                groupToggle.textContent = 'expand_more';
                groupToggle.dataset.group = task.id;
                groupToggle.onclick = () => toggleGroup(task.id);
                titleContainer.appendChild(groupToggle);
            }
            
            const title = document.createElement('span');
            title.className = 'task-title';
            title.textContent = task.title;
            titleContainer.appendChild(title);
            header.appendChild(titleContainer);
            
            // アクションボタン
            const actions = document.createElement('div');
            actions.className = 'task-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'button button-icon';
            editBtn.innerHTML = '<span class="material-icons">edit</span>';
            editBtn.onclick = () => startEditing(task);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'button button-icon';
            deleteBtn.innerHTML = '<span class="material-icons">delete</span>';
            deleteBtn.onclick = () => deleteTask(task.id);
            
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            header.appendChild(actions);
            
            content.appendChild(header);
            
            // メ��情報
            const meta = document.createElement('div');
            meta.className = 'task-meta';
            
            // 期限
            if (task.due_date) {
                const dueDate = new Date(task.due_date);
                const today = new Date();
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                const dueDateSpan = document.createElement('span');
                dueDateSpan.className = 'meta-item';
                
                const dueDateIcon = document.createElement('span');
                dueDateIcon.className = 'material-icons';
                
                if (diffDays < 0) {
                    dueDateSpan.classList.add('urgent');
                    dueDateIcon.textContent = 'error';
                    dueDateSpan.innerHTML += `期限切れ (${dueDate.toLocaleDateString()})`;
                    showNotification(`「${task.title}」は期限切れです！`);
                } else if (diffDays <= 3) {
                    dueDateSpan.classList.add('warning');
                    dueDateIcon.textContent = 'warning';
                    dueDateSpan.innerHTML += `あと${diffDays}日 (${dueDate.toLocaleDateString()})`;
                    if (!task.completed) {
                        showNotification(`「${task.title}」の期限が迫っています！`);
                    }
                } else {
                    dueDateIcon.textContent = 'event';
                    dueDateSpan.innerHTML += dueDate.toLocaleDateString();
                }
                
                dueDateSpan.prepend(dueDateIcon);
                meta.appendChild(dueDateSpan);
            }
            
            // 優先度
            const prioritySpan = document.createElement('span');
            prioritySpan.className = `meta-item priority-badge priority-${task.priority}`;
            const priorityIcon = document.createElement('span');
            priorityIcon.className = 'material-icons';
            priorityIcon.textContent = {
                'high': 'priority_high',
                'medium': 'remove',
                'low': 'arrow_downward'
            }[task.priority];
            prioritySpan.appendChild(priorityIcon);
            prioritySpan.appendChild(document.createTextNode(
                {'high': '高', 'medium': '中', 'low': '低'}[task.priority]
            ));
            meta.appendChild(prioritySpan);
            
            // カテゴリー
            if (task.category) {
                const categorySpan = document.createElement('span');
                categorySpan.className = 'meta-item';
                const categoryIcon = document.createElement('span');
                categoryIcon.className = 'material-icons';
                categoryIcon.textContent = 'folder';
                categorySpan.appendChild(categoryIcon);
                categorySpan.appendChild(document.createTextNode(task.category));
                meta.appendChild(categorySpan);
            }
            
            content.appendChild(meta);
            
            // タグ
            if (task.tags && task.tags.length > 0) {
                const tags = document.createElement('div');
                tags.className = 'task-tags';
                task.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'meta-item';
                    const tagIcon = document.createElement('span');
                    tagIcon.className = 'material-icons';
                    tagIcon.textContent = 'label';
                    tagSpan.appendChild(tagIcon);
                    tagSpan.appendChild(document.createTextNode(tag));
                    tags.appendChild(tagSpan);
                });
                content.appendChild(tags);
            }
            
            // 進捗バー
            if (task.total_steps > 0) {
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';
                
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                const progressFill = document.createElement('div');
                progressFill.className = 'progress-bar-fill';
                const progressPercent = (task.progress / task.total_steps) * 100;
                progressFill.style.width = `${progressPercent}%`;
                progressBar.appendChild(progressFill);
                
                const progressInfo = document.createElement('div');
                progressInfo.className = 'progress-info';
                const progressText = document.createElement('span');
                progressText.textContent = `進捗: ${task.progress}/${task.total_steps} (${Math.round(progressPercent)}%)`;
                
                const progressButtons = document.createElement('div');
                progressButtons.className = 'progress-buttons';
                
                if (task.progress > 0) {
                    const decrementBtn = document.createElement('button');
                    decrementBtn.className = 'button button-icon';
                    decrementBtn.innerHTML = '<span class="material-icons">remove</span>';
                    decrementBtn.onclick = () => updateProgress(task.id, task.progress - 1);
                    progressButtons.appendChild(decrementBtn);
                }
                
                if (task.progress < task.total_steps) {
                    const incrementBtn = document.createElement('button');
                    incrementBtn.className = 'button button-icon';
                    incrementBtn.innerHTML = '<span class="material-icons">add</span>';
                    incrementBtn.onclick = () => updateProgress(task.id, task.progress + 1);
                    progressButtons.appendChild(incrementBtn);
                }
                
                progressInfo.appendChild(progressText);
                progressInfo.appendChild(progressButtons);
                
                progressContainer.appendChild(progressBar);
                progressContainer.appendChild(progressInfo);
                content.appendChild(progressContainer);
            }
            
            // サブタスク
            if (task.subtasks && task.subtasks.length > 0) {
                const subtasksContainer = document.createElement('div');
                subtasksContainer.className = 'subtasks';
                
                task.subtasks.forEach(subtask => {
                    const subtaskDiv = document.createElement('div');
                    subtaskDiv.className = 'subtask-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'task-checkbox';
                    checkbox.checked = subtask.completed;
                    checkbox.onchange = () => toggleSubtask(subtask.id);
                    
                    const subtaskTitle = document.createElement('span');
                    subtaskTitle.textContent = subtask.title;
                    if (subtask.completed) {
                        subtaskTitle.style.textDecoration = 'line-through';
                    }
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'button button-icon';
                    deleteBtn.innerHTML = '<span class="material-icons">close</span>';
                    deleteBtn.onclick = () => deleteSubtask(subtask.id);
                    
                    subtaskDiv.appendChild(checkbox);
                    subtaskDiv.appendChild(subtaskTitle);
                    subtaskDiv.appendChild(deleteBtn);
                    subtasksContainer.appendChild(subtaskDiv);
                });
                
                const addSubtaskBtn = document.createElement('button');
                addSubtaskBtn.className = 'button button-secondary';
                addSubtaskBtn.innerHTML = '<span class="material-icons">add</span>サブタスクを追加';
                addSubtaskBtn.onclick = () => addSubtask(task.id);
                
                content.appendChild(subtasksContainer);
                content.appendChild(addSubtaskBtn);
            } else {
                const addSubtaskBtn = document.createElement('button');
                addSubtaskBtn.className = 'button button-secondary';
                addSubtaskBtn.innerHTML = '<span class="material-icons">add</span>サブタスクを追加';
                addSubtaskBtn.onclick = () => addSubtask(task.id);
                content.appendChild(addSubtaskBtn);
            }
            
            li.appendChild(content);
            return li;
        }

        // ドラッグ&ドロップの設定を追加
        function setupDragAndDrop() {
            const taskList = document.getElementById('taskList');
            const sortable = new Sortable(taskList, {
                animation: 150,
                draggable: '.task-item',
                handle: '.task-header',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: async function(evt) {
                    const taskId = evt.item.dataset.id;
                    const tasks = Array.from(taskList.children);
                    const newPosition = tasks.findIndex(task => task.dataset.id === taskId);
                    
                    try {
                        await fetch(`${API_URL}/tasks/${taskId}/position`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ position: newPosition }),
                        });
                    } catch (error) {
                        console.error('タスクの位置更新に失敗しました:', error);
                    }
                }
            });
            return sortable;
        }

        // タスクを削除
        async function deleteTask(id) {
            if (!confirm('本当に削除しますか？')) return;
            try {
                const response = await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('タスクの削除に失敗しました:', error);
            }
        }

        // タスクの完了状態を切り替え
        async function toggleTask(id) {
            try {
                // まず現在のタスクの状態を取得
                const taskResponse = await fetch(`${API_URL}/tasks/${id}`);
                const task = await taskResponse.json();
                
                // 完了状態を反転
                const response = await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ completed: !task.completed }),
                });
                
                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('タスクの状態変更に失敗しました:', error);
            }
        }

        // サブタスクを追加
        async function addSubtask(taskId) {
            const title = prompt('サブタスクのタイトルを入力してください:');
            if (title) {
                try {
                    const response = await fetch(`${API_URL}/tasks/${taskId}/subtasks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ title }),
                    });
                    if (response.ok) {
                        loadTasks();
                    }
                } catch (error) {
                    console.error('サブタスクの追加に失敗しました:', error);
                }
            }
        }

        // サブタスクの完了状態を切り替え
        async function toggleSubtask(id) {
            try {
                const response = await fetch(`${API_URL}/subtasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ completed: true }),
                });
                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('サブタスクの状態変更に失敗しました:', error);
            }
        }

        // サブタスクを削除
        async function deleteSubtask(id) {
            if (confirm('このサブタスクを削除しますか？')) {
                try {
                    const response = await fetch(`${API_URL}/subtasks/${id}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        loadTasks();
                    }
                } catch (error) {
                    console.error('サブタスクの削除に失敗しました:', error);
                }
            }
        }

        // 編集モードを開始
        function startEditing(task) {
            currentEditingId = task.id;
            document.getElementById('taskInput').value = task.title;
            document.getElementById('dueDateInput').value = task.due_date ? task.due_date.split('T')[0] : '';
            document.getElementById('priorityInput').value = task.priority;
            document.getElementById('categoryInput').value = task.category || '';
            document.getElementById('tagsInput').value = task.tags ? task.tags.join(', ') : '';
            document.getElementById('recurrenceType').value = task.recurrence_type || '';
            document.getElementById('recurrenceInterval').value = task.recurrence_interval || '1';
            document.getElementById('totalSteps').value = task.total_steps || '';
            document.getElementById('groupSelect').value = task.group_id || '';
            document.querySelector('button[type="submit"]').textContent = '更新';
        }

        // 通知を表示
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        // カテゴリーフィルターを更新
        async function updateCategoryFilter() {
            try {
                const response = await fetch(`${API_URL}/tasks?status=all`);
                const tasks = await response.json();
                const categories = new Set(tasks.map(task => task.category).filter(Boolean));
                
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">カテゴリー: 全て</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = `カテゴリー: ${category}`;
                    categoryFilter.appendChild(option);
                });
            } catch (error) {
                console.error('カテゴリー一覧の取得に失敗しました:', error);
            }
        }

        // ソート方向を切り替え
        function toggleSortDirection() {
            const btn = document.getElementById('sortDirection');
            const isAsc = btn.textContent.trim() === '↑';
            btn.textContent = isAsc ? '↓' : '↑';
            loadTasks();
        }

        // ソート順を更新
        function updateSortOrder() {
            const sortField = document.getElementById('sortField').value;
            if (sortField === 'position') {
                document.getElementById('sortDirection').style.display = 'none';
            } else {
                document.getElementById('sortDirection').style.display = 'inline-block';
            }
            loadTasks();
        }
    </script>
</body>
</html>